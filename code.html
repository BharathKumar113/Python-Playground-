<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Python Interpreter</title>
  
  <!-- CodeMirror v6 -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/python/python.min.js"></script>
  
  <style>
    :root {
      --bg-dark: #1e1e2f;
      --bg-light: #2c2c3e;
      --accent: #4cafef;
      --text: #f5f5f5;
      --output-bg: #111;
      --output-text: #0f0;
      --border: #444;
      --editor-bg: #1b1b2d;
      --button-hover: #3a9edb;
      --error-line: #ff4d4d;
      /* Light theme */
      --bg-dark-light: #f5f5f5;
      --bg-light-light: #e0e0e0;
      --accent-light: #0288d1;
      --text-light: #333;
      --output-bg-light: #fff;
      --output-text-light: #000;
      --border-light: #ccc;
      --editor-bg-light: #fff;
      --button-hover-light: #0277bd;
      --error-line-light: #ff6666;
    }

    [data-theme="light"] {
      --bg-dark: var(--bg-dark-light);
      --bg-light: var(--bg-light-light);
      --accent: var(--accent-light);
      --text: var(--text-light);
      --output-bg: var(--output-bg-light);
      --output-text: var(--output-text-light);
      --border: var(--border-light);
      --editor-bg: var(--editor-bg-light);
      --button-hover: var(--button-hover-light);
      --error-line: var(--error-line-light);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: "Segoe UI", Arial, sans-serif;
      background: var(--bg-dark);
      color: var(--text);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      transition: all 0.3s;
    }

    header {
      background: var(--bg-light);
      padding: 12px 16px;
      font-size: 1.2rem;
      font-weight: bold;
      color: var(--accent);
      text-align: center;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .theme-toggle {
      background: none;
      border: none;
      color: var(--text);
      font-size: 1rem;
      cursor: pointer;
      padding: 4px 8px;
    }

    .navbar {
      background: var(--bg-light);
      padding: 8px;
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
      border-bottom: 1px solid var(--border);
    }

    .container {
      flex: 1;
      display: flex;
      flex-direction: row;
      gap: 5px;
      padding: 12px;
      position: relative;
    }

    .editor, .right {
      display: flex;
      flex-direction: column;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid var(--border);
    }

    .editor {
      background: var(--editor-bg);
      flex: 1;
      min-width: 200px;
    }

    .right {
      background: var(--output-bg);
      flex: 1;
      min-width: 200px;
    }

    .resize-divider {
      width: 5px;
      background: var(--border);
      cursor: col-resize;
      transition: background 0.2s;
    }

    .resize-divider:hover {
      background: var(--accent);
    }

    .tabs {
      display: flex;
      background: var(--bg-light);
      padding: 8px;
      gap: 8px;
      flex-wrap: wrap;
    }

    .tab {
      padding: 6px 12px;
      background: var(--bg-dark);
      color: var(--text);
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.2s;
    }

    .tab.active {
      background: var(--accent);
      color: white;
    }

    .tab:hover {
      background: var(--button-hover);
    }

    .controls {
      padding: 8px;
      background: var(--bg-light);
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
    }

    button {
      background: var(--accent);
      border: none;
      color: white;
      padding: 8px 14px;
      border-radius: 6px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }

    button:hover {
      background: var(--button-hover);
    }

    #output {
      flex: 1;
      padding: 10px;
      background: var(--output-bg);
      color: var(--output-text);
      overflow-y: auto;
      font-family: monospace;
      font-size: 0.9rem;
      white-space: pre-wrap;
    }

    .spinner {
      border: 4px solid var(--text);
      border-top: 4px solid var(--accent);
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
      margin: 10px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .CodeMirror {
      height: 100%;
      font-size: 0.95rem;
      padding: 10px;
      color: var(--text);
      background: var(--editor-bg);
    }

    [data-theme="light"] .CodeMirror {
      background: var(--editor-bg-light);
      color: #000;
    }

    .cm-error-line {
      background-color: var(--error-line);
    }

    @media (max-width: 768px) {
      .container {
        flex-direction: column;
      }
      .editor, .right { height: 40vh; }
      .resize-divider { display: none; }
    }

    @media (max-width: 480px) {
      header {
        font-size: 1rem;
        padding: 10px;
      }
      button, .tab {
        padding: 6px 10px;
        font-size: 0.8rem;
      }
      .CodeMirror {
        font-size: 0.85rem;
      }
    }
  </style>
</head>
<body data-theme="dark">
  <header>
    üêç Python Interpreter (Pyodide)
    <button class="theme-toggle" aria-label="Toggle theme">üåô</button>
  </header>
  <div class="navbar">
    <button id="clearBtn" aria-label="Clear output">Clear</button>
    <button id="saveBtn" aria-label="Save code">Save</button>
    <button id="downloadBtn" aria-label="Download code">Download</button>
    <button id="shareBtn" aria-label="Share code">Share</button>
    <button id="newTabBtn" aria-label="New file">New File</button>
    <input id="packageInput" type="text" placeholder="Enter package name" aria-label="Python package name">
    <button id="installBtn" aria-label="Install package">Install Package</button>
  </div>
  <div class="container">
    <div class="editor" id="editor" role="textbox" aria-label="Python code editor">
      <div class="tabs" id="tabs">
        <div class="tab active" data-tab="0">main.py</div>
      </div>
      <div id="editor-content"></div>
    </div>
    <div class="resize-divider"></div>
    <div class="right">
      <div class="controls">
        <button id="runBtn" aria-label="Run Python code">Run (Ctrl+Enter)</button>
      </div>
      <div id="output" role="log" aria-live="polite">Loading Pyodide... <div class="spinner"></div></div>
    </div>
  </div>

  <!-- Pyodide -->
  <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>
  <script>
    const editors = [];
    let currentTab = 0;
    let pyodideReady = false;
    let pyodide = null;

    const editorContainer = document.getElementById("editor-content");
    const output = document.getElementById("output");
    const runBtn = document.getElementById("runBtn");
    const clearBtn = document.getElementById("clearBtn");
    const saveBtn = document.getElementById("saveBtn");
    const downloadBtn = document.getElementById("downloadBtn");
    const shareBtn = document.getElementById("shareBtn");
    const newTabBtn = document.getElementById("newTabBtn");
    const packageInput = document.getElementById("packageInput");
    const installBtn = document.getElementById("installBtn");
    const themeToggle = document.querySelector(".theme-toggle");
    const tabsContainer = document.getElementById("tabs");

    function createEditor(index) {
      const editorDiv = document.createElement("div");
      editorDiv.id = `editor-${index}`;
      editorDiv.style.display = index === currentTab ? "block" : "none";
      editorContainer.appendChild(editorDiv);

      const editor = CodeMirror(editorDiv, {
        mode: "python",
        lineNumbers: true,
        value: `# File ${index + 1}\nfor i in range(5):\n    print("Hello", i)`,
        tabSize: 4,
        indentUnit: 4,
        matchBrackets: true,
        autoCloseBrackets: true,
      });
      editors.push({ editor, code: editor.getValue() });
      return editor;
    }

    function switchTab(index) {
      editors[currentTab].editor.getWrapperElement().style.display = "none";
      document.querySelector(`.tab[data-tab="${currentTab}"]`).classList.remove("active");
      currentTab = index;
      editors[currentTab].editor.getWrapperElement().style.display = "block";
      document.querySelector(`.tab[data-tab="${currentTab}"]`).classList.add("active");
      editors[currentTab].editor.refresh();
      editors[currentTab].editor.focus();
    }

    function addTab() {
      const index = editors.length;
      const tab = document.createElement("div");
      tab.className = "tab";
      tab.dataset.tab = index;
      tab.textContent = `file${index + 1}.py`;
      tab.addEventListener("click", () => switchTab(index));
      tabsContainer.appendChild(tab);
      createEditor(index);
      switchTab(index);
    }

    
    createEditor(0);

    async function main() {
      output.innerHTML = "Loading Pyodide (may take a few seconds)... <div class='spinner'></div>";
      try {
        pyodide = await loadPyodide({ indexURL: "https://cdn.jsdelivr.net/pyodide/v0.25.0/full/" });
        await pyodide.loadPackage("micropip");
        pyodideReady = true;
        output.innerHTML = "‚úÖ Ready! Write code and press Run or Ctrl+Enter.";
      } catch (err) {
        output.innerHTML = `Failed to load Pyodide: ${err.message}`;
      }
    }
    main();

    function printOut(msg) {
      output.textContent += msg + "\n";
      output.scrollTop = output.scrollHeight;
    }

    function highlightErrorLine(lineNumber) {
      editors.forEach(({ editor }) => editor.getAllMarks().forEach(mark => mark.clear()));
      if (lineNumber > 0) {
        editors[currentTab].editor.markText(
          { line: lineNumber - 1, ch: 0 },
          { line: lineNumber - 1, ch: Infinity },
          { className: "cm-error-line" }
        );
      }
    }

    runBtn.addEventListener("click", async () => {
      if (!pyodideReady) {
        printOut("Still loading Pyodide...");
        return;
      }
      output.textContent = "";
      editors[currentTab].code = editors[currentTab].editor.getValue();

      await pyodide.runPythonAsync(`
import sys, io
sys.stdout = io.StringIO()
sys.stderr = io.StringIO()
`);
      try {
        await pyodide.runPythonAsync(editors[currentTab].code);
        const stdout = pyodide.runPython("sys.stdout.getvalue()");
        const stderr = pyodide.runPython("sys.stderr.getvalue()");
        if (stdout) {
          printOut(stdout);
        } else if (!stderr) {
          printOut("Code ran successfully");
        }
        if (stderr) printOut("[stderr]\n" + stderr);
        highlightErrorLine(0);
      } catch (err) {
        const errorLines = err.toString().split('\n');
        const lineNumberMatch = errorLines.find(line => line.match(/line \d+/)) || '';
        const lineNumber = lineNumberMatch.match(/\d+/) ? parseInt(lineNumberMatch.match(/\d+/)[0]) : 0;
        printOut(`Error: ${err.message}\n${lineNumberMatch}`);
        highlightErrorLine(lineNumber);
      }
    });

    clearBtn.addEventListener("click", () => {
      output.textContent = "";
      editors.forEach(({ editor }) => editor.getAllMarks().forEach(mark => mark.clear()));
    });

    saveBtn.addEventListener("click", () => {
      editors[currentTab].code = editors[currentTab].editor.getValue();
      localStorage.setItem("savedCode", JSON.stringify(editors.map(e => e.code)));
      printOut("Code saved to localStorage!");
    });

    downloadBtn.addEventListener("click", () => {
      const code = editors[currentTab].editor.getValue();
      const blob = new Blob([code], { type: "text/x-python" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `file${currentTab + 1}.py`;
      a.click();
      URL.revokeObjectURL(url);
      printOut("Code downloaded!");
    });

    shareBtn.addEventListener("click", () => {
      editors[currentTab].code = editors[currentTab].editor.getValue();
      const encodedCode = encodeURIComponent(editors[currentTab].code);
      const shareUrl = `${window.location.origin}${window.location.pathname}?code=${encodedCode}`;
      navigator.clipboard.writeText(shareUrl);
      printOut(`Shareable link copied to clipboard: ${shareUrl}`);
    });

    newTabBtn.addEventListener("click", addTab);

    installBtn.addEventListener("click", async () => {
      if (!pyodideReady) {
        printOut("Still loading Pyodide...");
        return;
      }
      const packageName = packageInput.value.trim();
      if (!packageName) {
        printOut("Please enter a package name.");
        return;
      }
      output.textContent = `Installing ${packageName}...`;
      try {
        await pyodide.runPythonAsync(`
import micropip
await micropip.install('${packageName}')
`);
        printOut(`${packageName} installed successfully!`);
      } catch (err) {
        printOut(`Failed to install ${packageName}: ${err.message}`);
      }
    });

    themeToggle.addEventListener("click", () => {
      const body = document.body;
      const isLight = body.dataset.theme === "light";
      body.dataset.theme = isLight ? "dark" : "light";
      themeToggle.textContent = isLight ? "üåô" : "‚òÄÔ∏è";
    });

    editors[currentTab].editor.on("keydown", (cm, event) => {
      if (event.ctrlKey && event.key === "Enter") {
        runBtn.click();
      }
    });

    
    const divider = document.querySelector(".resize-divider");
    let isResizing = false;

    divider.addEventListener("mousedown", (e) => {
      isResizing = true;
      document.addEventListener("mousemove", resize);
      document.addEventListener("mouseup", () => {
        isResizing = false;
        document.removeEventListener("mousemove", resize);
      });
    });

    function resize(e) {
      if (!isResizing) return;
      const container = document.querySelector(".container");
      const editor = document.querySelector(".editor");
      const right = document.querySelector(".right");
      const containerRect = container.getBoundingClientRect();
      const newEditorWidth = e.clientX - containerRect.left;
      const minWidth = 200;
      if (newEditorWidth > minWidth && newEditorWidth < containerRect.width - minWidth) {
        editor.style.flex = `0 0 ${newEditorWidth}px`;
        right.style.flex = `1 0 ${containerRect.width - newEditorWidth - 5}px`;
      }
    }

    
    const urlParams = new URLSearchParams(window.location.search);
    const sharedCode = urlParams.get("code");
    if (sharedCode) {
      editors[currentTab].editor.setValue(decodeURIComponent(sharedCode));
      editors[currentTab].code = decodeURIComponent(sharedCode);
      printOut("Loaded shared code from URL.");
    }
  </script>
</body>
</html>